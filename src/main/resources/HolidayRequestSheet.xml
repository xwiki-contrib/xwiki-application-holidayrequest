<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>HolidayRequest</web>
  <name>HolidayRequestSheet</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>HolidayRequest.HolidayRequestClass</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1354791388000</creationDate>
  <date>1354893003000</date>
  <contentUpdateDate>1354892946000</contentUpdateDate>
  <version>1.1</version>
  <title>$msg.get('contrib.hr.requestPage.title')</title>
  <template/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>HolidayRequest.HolidayRequestSheet</name>
    <number>0</number>
    <className>XWiki.XWikiRights</className>
    <guid>75261aa3-2a2d-487e-9d57-b3c925c08586</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>XWiki.HolidayRequestAdminGroup</groups>
    </property>
    <property>
      <levels>view,edit,comment,delete</levels>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>HolidayRequest.HolidayRequestSheet</name>
    <number>1</number>
    <className>XWiki.XWikiRights</className>
    <guid>80e5e521-40cb-4773-8dfe-c0030fb8fc5d</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>XWiki.XWikiAllGroup</groups>
    </property>
    <property>
      <levels>view</levels>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>HolidayRequest.HolidayRequestSheet</name>
    <number>2</number>
    <className>XWiki.XWikiRights</className>
    <guid>ebeb80e9-d142-468c-a073-7a7ce99a1ede</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>XWiki.XWikiAdminGroup</groups>
    </property>
    <property>
      <levels>view</levels>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>HolidayRequest.HolidayRequestSheet</name>
    <number>3</number>
    <className>XWiki.XWikiRights</className>
    <guid>0bb76d2d-9532-4942-b27e-ce7518feabff</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <levels>view</levels>
    </property>
    <property>
      <users>XWiki.XWikiGuest</users>
    </property>
  </object>
  <content>{{velocity}}
$xwiki.ssx.use("HolidayRequest.SkinExtension")
#set($employee = $!doc.getValue('employee'))
#set($manager = $!doc.getValue('manager'))
#set($user = $xwiki.getDocument($context.user))
#set($fullUser = "xwiki:$user")
#set($mail = $xwiki.getUserName($user, '$email', false))
#set($employeeMail = $xwiki.getUserName($employee, '$email', false))
#set($employeeShortName = $xwiki.getUserName($employee, '$first_name $last_name', false))
#set($employeeName = $xwiki.getUserName($employee, "$first_name $last_name", true))
#set($managerMail = $xwiki.getUserName($manager, '$email', false))
#set($isHRAdmin = $xwiki.getUser().isUserInGroup("XWiki.HolidayRequestAdminGroup") || $user==$manager || $fullUser==$manager)
#set($locale = $datetool.getLocale())
#set($hasRightModify = $isHRAdmin || ($user==$employee &amp;&amp; $doc.getValue('status')=='value3'))
#set($startDate = $datetool.format('full_date',$!doc.getValue("startDate"),$locale))
#set($endDate = $datetool.format('full_date',$!doc.getValue("endDate"),$locale))
#set($hr = $doc.getObject("HolidayRequest.HolidayRequestClass"))
#set($link = $doc.getExternalURL())
#set($token = $services.csrf.getToken())

#if($request.createHR=="true")
  $doc.set('employee', $context.user)  ##It's the current user who is making a Holiday Request
  #set($office = $!xwiki.getUserName($user, '$office', false))
  #if($office!='$office')
    $doc.set('office', $office)
  #else
    $doc.set('office', '-')
  #end
  $doc.set('status', 'value3')  ##The status is "Pending"
  $doc.save()
  $response.sendRedirect($doc.getURL('view', 'newDoc=true'))
#end
#if($request.cancel)
  $doc.delete()
  $response.sendRedirect($xwiki.getURL('HolidayRequest.WebHome'))
#end
#if($request.newDoc=='true')
  #set($newDoc=true)
#else
  #set($newDoc=false)
#end
#if ($request.notify == 'true') 
  ##$doc.set('numberDays', $request.numberDays)
  ##$doc.save()
  #if($doc.getValue('manager')=="")  ##Si pas de manager d√©fini
    {{warning}}$msg.get('contrib.hr.notify.error.noManager'){{/warning}}
    #set($newDoc=true)
  #else
    #if($doc.getValue('startDate').compareTo($doc.getValue('endDate'))==1)  ##If endDate is before startDate
      {{warning}}$msg.get('contrib.hr.notify.error.orderDate'){{/warning}}
      #set($newDoc=true)
    #else
      #if($employeeShortName != "")
        #set($title = $msg.get('contrib.hr.email.notify.title', [$employeeShortName,$startDate,$endDate]))
      #else
        #set($title = $msg.get('contrib.hr.email.notify.title', [$employee,$startDate,$endDate]))
      #end
      #set($message = $msg.get('contrib.hr.email.notify.text', [$employeeShortName,$startDate,$endDate]))
      #if($xwiki.mailsender.sendHtmlMessage("$context.user", $managerMail, $xwiki.null, $xwiki.null, $title, "$message &lt;a href=$link&gt;$link&lt;/a&gt;", "", "")==0)  ##Send a copy to employee?
        $msg.get('contrib.hr.email.notify.success')
      #else
        {{warning}}$msg.get('contrib.hr.email.notify.failure'){{/warning}}
      #end
    #end
  #end
#end
#if ($request.accept &amp;&amp; $isHRAdmin)
  $doc.set('status', 'value1')
  $doc.save()
  #set($title = $msg.get('contrib.hr.email.accept.title', [$startDate,$endDate]))
  #set($message = $msg.get('contrib.hr.email.accept.text', [$startDate,$endDate]))
  #if($xwiki.mailsender.sendHtmlMessage("$context.user", $employeeMail, $xwiki.null, $xwiki.null, $title, "$message &lt;a href=$link&gt;$link&lt;/a&gt;", "", "")==0)
    $msg.get('contrib.hr.email.accept.success')
  #else
    {{warning}}$msg.get('contrib.hr.email.accept.failure'){{/warning}}
  #end
#end
#if ($request.refuse &amp;&amp; $isHRAdmin)
  $doc.set('status', 'value4')
  $doc.save()
  #set($title = $msg.get('contrib.hr.email.refuse.title', [$startDate,$endDate]))
  #set($message = $msg.get('contrib.hr.email.refuse.text', [$startDate,$endDate]))
  #if($xwiki.mailsender.sendHtmlMessage("$context.user", $employeeMail, $xwiki.null, $xwiki.null, $title, "$message &lt;a href=$link&gt;$link&lt;/a&gt;", "", "")==0)
    $msg.get('contrib.hr.email.refuse.success')
  #else
    {{warning}}$msg.get('contrib.hr.email.refuse.failure'){{/warning}}
  #end
#end
#if ($request.cancel == 'true' &amp;&amp; $user==$employee)
  $doc.set('status', 'value2')
  $doc.save()
  #if($employeeShortName != "")
    #set($title = $msg.get('contrib.hr.email.cancel.title', [$employeeShortName,$startDate,$endDate]))
  #else
    #set($title = $msg.get('contrib.hr.email.cancel.title', [$employee,$startDate,$endDate]))
  #end
  #set($title = $msg.get('contrib.hr.email.cancel.title', [$employeeShortName,$startDate,$endDate]))
  #set($message = $msg.get('contrib.hr.email.cancel.text', [$employeeShortName,$startDate,$endDate]))
  #if($xwiki.mailsender.sendHtmlMessage("$context.user", $managerMail, $xwiki.null, $xwiki.null, $title, "$message &lt;a href=$link&gt;$link&lt;/a&gt;", "", "")==0)  ##Send a copy to employee?
    $msg.get('contrib.hr.email.cancel.success')
  #else
    {{warning}}$msg.get('contrib.hr.email.cancel.failure'){{/warning}}
  #end
#end
#if($!{request.exportPDF}=='true')
  $response.sendRedirect($doc.getURL('export', 'format=pdf&amp;pdftemplate=Holiday+Request.PDFTemplate&amp;pdfcover=0&amp;pdftoc=0'))
#end

{{html wiki="true"}}
$xwiki.ssx.use('AppWithinMinutes.ClassSheetGenerator')
#set($discard = $doc.use('HolidayRequest.HolidayRequestClass'))
## We don't have access to the form element to set the CSS class for the vertical form layout standard.

#if($hr)
$doc.setTitle($msg.get('contrib.hr.requestPage.title'))
#if($context.action == "view" &amp;&amp; !$newDoc)
  #if($xwiki.getUserName($employee, '$first_name$last_name', false)!="")
    #set($employeeDisplay = $employeeName)
  #else
    #set($employeeDisplay = $doc.display('employee'))
  #end
  $msg.get('contrib.hr.request', [$employeeDisplay, $startDate, $endDate])  
  ; &lt;label for="HolidayRequest.HolidayRequestClass_0_numberDays"&gt;$msg.get('contrib.hr.numberDays') :&lt;/label&gt;##
    (% class="xHint" %)$msg.get('')
  : $doc.display('numberDays')
  ; &lt;label for="HolidayRequest.HolidayRequestClass_0_manager"&gt;$msg.get('contrib.hr.manager') :&lt;/label&gt;##
    (% class="xHint" %)$msg.get('')
  : $doc.display('manager')
  ; &lt;label for="HolidayRequest.HolidayRequestClass_0_status"&gt;$msg.get('contrib.hr.status') :&lt;/label&gt;##
    (% class="xHint" %)$msg.get('')
  : $doc.display("status")


    #set($actualStatus = $doc.getValue('status'))
    #if($isHRAdmin &amp;&amp; $actualStatus == 'value3')  ##If admin rights and status=Pending
    &lt;div id="actions"&gt;
      &lt;form action="" id="statusAccepted"&gt;
        &lt;div&gt;
          &lt;span class="buttonwrapper"&gt;
            ##&lt;input type="hidden" name="accept" value="true" /&gt;
            &lt;input class="button" type="submit" name="accept" value="$msg.get('contrib.hr.accept.submit')" /&gt;
          &lt;/span&gt;
        
          &lt;span class="buttonwrapper"&gt;
            ##&lt;input type="hidden" name="refuse" value="true" /&gt;
            &lt;input class="button" type="submit" name="refuse" value="$msg.get('contrib.hr.refuse.submit')" /&gt;
          &lt;/span&gt;
        &lt;/div&gt;
      &lt;/form&gt;
    &lt;div&gt;
    #end

    #if($user == $employee &amp;&amp; $doc.getValue('status') == 'value3')
    &lt;div id="actions"&gt;
      &lt;form action="" id="statusCancelled"&gt;
        &lt;div&gt;
          &lt;span class="buttonwrapper"&gt;
            &lt;input type="hidden" name="cancel" value="true" /&gt;
            &lt;input class="button" type="submit" value="$msg.get('contrib.hr.cancel.submit')" /&gt;
          &lt;/span&gt;
        &lt;/div&gt;
      &lt;/form&gt;
    &lt;/div&gt;
    #end

#elseif($context.action=="view" &amp;&amp; $newDoc)
    &lt;form action="" method="post" id="sendNotification" class='xform'"&gt;
      &lt;div&gt;  
        &lt;input type="hidden" name="form_token" value=$token&gt;
        ; &lt;label for="HolidayRequest.HolidayRequestClass_0_employee"&gt;$msg.get('contrib.hr.employee')&lt;/label&gt;##
          (% class="xHint" %)$msg.get('')
        : $!doc.display('employee')
        ; &lt;label for="HolidayRequest.HolidayRequestClass_0_startDate"&gt;$msg.get('contrib.hr.startDate')&lt;/label&gt;##
          (% class="xHint" %)$msg.get('')
        : $doc.display('startDate', 'edit')
        ; &lt;label for="HolidayRequest.HolidayRequestClass_0_endDate"&gt;$msg.get('contrib.hr.endDate')&lt;/label&gt;##
          (% class="xHint" %)$msg.get('')
        : $doc.display('endDate', 'edit')
        ; &lt;label for="HolidayRequest.HolidayRequestClass_0_numberDays"&gt;$msg.get('contrib.hr.numberDays')&lt;/label&gt;##
          (% class="xHint" %)$msg.get('')
        : $doc.display('numberDays', 'edit')
        ; &lt;label for="HolidayRequest.HolidayRequestClass_0_manager"&gt;$msg.get('contrib.hr.manager')&lt;/label&gt;##
          (% class="xHint" %)$msg.get('')
        : $doc.display('manager', 'edit')
        ; &lt;label for="HolidayRequest.HolidayRequestClass_0_status"&gt;$msg.get('contrib.hr.status')&lt;/label&gt;##
          (% class="xHint" %)$msg.get('')
        : $doc.display('status')
        &lt;input type="hidden" name="notify" value="true" /&gt;
        &lt;div id="actions"&gt;
          &lt;span class="buttonwrapper"&gt;
            &lt;input class="button" type="submit" value="$msg.get('contrib.hr.notify.submit')" name="action_save"&gt;
          &lt;/span&gt;
          &lt;span class="buttonwrapper"&gt;
            &lt;input class="button" type="submit" value="$msg.get('contrib.hr.notify.cancel')" name="cancel"&gt;
          &lt;/span&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/form&gt;

#elseif($context.action == "export")
   #if($xwiki.getUserName($employee, '$first_name$last_name', false)!="")
    #set($employeeDisplay = $employeeShortName)
  #else
    #set($employeeDisplay = $doc.display('employee'))
  #end
  $msg.get('contrib.hr.pdf.request', [$employeeDisplay, $startDate, $endDate])
 
#else   ##Edit mode
  #if(!$hasRightModify &amp;&amp; !$newDoc)
    $msg.get('contrib.hr.error.noModif') 
  #else
  (% class="xform" %)
  (((
    ; &lt;label for="HolidayRequest.HolidayRequestClass_0_employee"&gt;$msg.get('contrib.hr.employee')&lt;/label&gt;##
      (% class="xHint" %)$msg.get('')
    : $!doc.display('employee','view')
    ; &lt;label for="HolidayRequest.HolidayRequestClass_0_startDate"&gt;$msg.get('contrib.hr.startDate')&lt;/label&gt;##
      (% class="xHint" %)$msg.get('')
    : $doc.display('startDate')
    ; &lt;label for="HolidayRequest.HolidayRequestClass_0_endDate"&gt;$msg.get('contrib.hr.endDate')&lt;/label&gt;##
      (% class="xHint" %)$msg.get('')
    : $doc.display('endDate')
    ; &lt;label for="HolidayRequest.HolidayRequestClass_0_numberDays"&gt;$msg.get('contrib.hr.numberDays')&lt;/label&gt;##
      (% class="xHint" %)$msg.get('')
    : $doc.display('numberDays')
    ; &lt;label for="HolidayRequest.HolidayRequestClass_0_manager"&gt;$msg.get('contrib.hr.manager')&lt;/label&gt;##
      (% class="xHint" %)$msg.get('')
    : $doc.display('manager')
    ; &lt;label for="HolidayRequest.HolidayRequestClass_0_status"&gt;$msg.get('contrib.hr.status')&lt;/label&gt;##
      (% class="xHint" %)$msg.get('')
    #if($isHRAdmin)
      : $doc.display('status')
    #else
      : $doc.display('status', 'view')
    #end
  )))
  #end
#end

#else
  $msg.get('contrib.hr.sheet.message')
#end

{{/html}}

{{/velocity}}</content>
</xwikidoc>
